# 士兵进攻与寻路逻辑说明文档

本文档详细说明了游戏中士兵的进攻决策流程和寻路算法的实现细节。

## 1. 进攻决策流程 (BasicSoldier::findTarget)

士兵在寻找攻击目标时，遵循一套严格的优先级逻辑，以确保行为符合兵种特性（如巨人优先攻击防御塔，炸弹人优先攻击墙）。

### 1.1 目标筛选优先级

系统会遍历所有可见且存活的建筑，并维护三个“最佳目标”候选：

1.  **优先目标 (Preferred Target)**
    *   根据兵种的 `AttackType` 决定。
    *   例如：巨人 -> 防御塔 (Defense)，哥布林 -> 资源 (Resource)。
    *   如果兵种没有特定偏好 (Any)，则非墙建筑视为优先。
2.  **备选目标 (Fallback Target)**
    *   任何非墙建筑。
    *   当优先目标不存在时（例如巨人摧毁了所有防御塔），会退而求其次攻击其他建筑。
3.  **墙目标 (Wall Target)**
    *   最后的选择。只有当没有其他路径可达时，或者炸弹人（优先攻墙）时才会考虑。

### 1.2 最终决策

决策逻辑如下：
```cpp
Building* finalTarget = bestPreferredTarget;
if (!finalTarget) {
    finalTarget = bestFallbackTarget;
}
if (!finalTarget) {
    finalTarget = bestWallTarget;
}
```
这意味着：**只要场上还有优先目标，士兵绝不会去打备选目标；只要还有普通建筑，士兵绝不会主动去打墙（除非被阻挡且寻路失败）。**

## 2. 攻击范围判定 (BasicSoldier::isInRange)

为了解决“隔空攻击”和“穿墙攻击”的视觉问题，我们采用了**精确边缘距离判定**。

### 2.1 判定逻辑

1.  **获取建筑网格边界**：计算目标建筑在网格上的矩形范围。
2.  **边界收缩 (Shrink)**：
    *   将有效判定区域向内收缩 `0.3` 个格子（约 12 像素）。
    *   **目的**：迫使士兵必须“走进”建筑的占地范围一点点，而不是站在网格线外攻击，增强视觉上的接触感。
    *   **安全保护**：收缩量被限制在建筑尺寸的一半以内，防止对 1x1 的小建筑（如墙）造成判定区域消失。
3.  **最近点计算 (Clamping)**：
    *   找到建筑收缩后的矩形边界上，距离士兵最近的一个点。
4.  **距离比较**：
    *   计算士兵当前位置到该最近点的屏幕像素距离。
    *   如果 `距离 <= AttackRange`，则判定为在攻击范围内。

### 2.2 配置调整

由于采用了边缘距离判定，士兵的 `AttackRange` 配置值需要相应调整：
*   **近战单位 (巨人/野蛮人)**：`AttackRange` 设为 **40** (1格宽)。这确保了他们必须贴近建筑，且无法隔着一堵墙（墙厚+间隙 > 40）攻击。
*   **远程单位 (弓箭手)**：`AttackRange` 设为 **200** (5格宽)。

## 3. 寻路算法 (PathFinder)

寻路系统基于 A* 算法，并针对游戏需求进行了多项优化。

### 3.1 精度倍增 (Precision)

*   为了让移动更平滑，寻路不在原始网格上进行，而是将网格细分（默认 `precision=2`）。
*   这意味着一个 40x40 的游戏格子被分为 2x2 个 20x20 的寻路格子。
*   这允许士兵走在网格的中心线或边缘，而不是只能走格点，减少了“走折线”的生硬感。

### 3.2 模糊目标 (Fuzzy Target)

当目标点不可通行（例如点击了建筑中心，或者目标是建筑本身）时，寻路器不会直接报错，而是：
1.  以目标点为中心，向外搜索一圈圈的网格。
2.  收集所有**可通行**的邻近网格作为“有效终点集合 (Valid End Points)”。
3.  A* 算法在搜索时，只要到达集合中任意一个点，即视为成功。
4.  **关键优化**：在所有可能的终点中，算法会倾向于选择距离**起点**最近的那一个，而不是距离目标中心最近的。这解决了“士兵绕远路去攻击建筑背面”的问题，让他们总是攻击最近的一面。

### 3.3 路径平滑与偏移

*   **中心点修正**：寻路返回的路径点被修正为小网格的中心 `(row+0.5, col+0.5)`，避免士兵贴着墙根走而被卡住。
*   **末端偏移**：在 `BasicSoldier` 中，当寻路成功且目标是建筑时，会在路径末端追加一个向建筑中心偏移 **20像素** 的点。这配合 `isInRange` 的收缩逻辑，引导士兵主动走进攻击范围。

## 4. 特殊兵种逻辑

### 4.1 炸弹人 (Bomber)

*   **穿墙逻辑**：炸弹人的寻路回调被特殊处理，将 `BuildingType::WALL` 所在的网格视为“可行走”。这允许寻路算法直接穿过墙壁规划路径。
*   **途中攻击**：炸弹人在移动过程中，会持续检测身边是否有墙。一旦发现射程内的墙壁，会立即中断移动并进行攻击。这防止了炸弹人“无视面前的墙去炸远处的墙”的愚蠢行为。

### 4.2 巨人 (Giant)

*   **优先防御**：巨人的 `AttackType` 为 `DEFENSE`。
*   **隔墙处理**：由于 `AttackRange` 缩短为 40，如果巨人被墙阻挡且无法绕路，寻路会失败。此时 `findTarget` 的回退逻辑会起作用，让巨人暂时攻击阻挡路径的墙壁（虽然优先级最低，但当无路可走时会成为唯一选择）。
