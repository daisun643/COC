# 存档系统说明文档

本文档详细说明了当前项目的存档系统架构，包括地图数据、玩家数据以及进攻回放数据的保存机制。

## 1. 路径管理 (PathUtils)

项目使用 `PathUtils` 类统一管理文件读写路径，以解决开发环境与运行环境的路径差异。

*   **开发模式 (Windows DevMode)**:
    *   系统会自动从可执行文件位置向上查找源码根目录下的 `Resources` 文件夹。
    *   所有读写操作直接作用于源码目录，确保数据在重新编译后依然保留，且方便版本控制。
*   **发布/移动模式**:
    *   使用标准的 `FileUtils` 路径逻辑（通常为可写路径或只读资源路径）。

## 2. 存档机制

### 2.1 建筑数据 (`map.json`)
建筑布局数据采用**即时保存 (Save-on-Change)** 策略，确保操作不丢失。

*   **文件位置**: `Resources/develop/map.json`
*   **保存时机**:
    *   **建造**: 放置新建筑时 (`BuildingManager::registerBuilding`)
    *   **移除**: 移除建筑时 (`BuildingManager::removeBuilding`)
    *   **升级**: 建筑升级完成时 (`GameScene`)
    *   **移动**: 拖拽建筑结束且位置有效时 (`BasicScene`)
*   **默认行为**: 若读取时文件缺失，系统会自动生成包含大本营和基础资源的默认地图。

### 2.2 玩家数据 (`user_data.json`)
玩家资源数据（金币、圣水）采用**定期备份 + 关键节点保存** 策略。

*   **文件位置**: `Resources/develop/user_data.json`
*   **保存时机**:
    *   **程序挂起/退出**: `AppDelegate::applicationDidEnterBackground`
    *   **自动备份**: 每 60 秒自动保存一次。
    *   **初始化**: 游戏启动时若无存档，资源初始化为 0，并在计算完建筑容量后自动填满。

### 2.3 资源容量计算
*   **逻辑**: 资源上限严格等于地图上所有 **储金罐 (GoldStorage)** 和 **圣水瓶 (ElixirBottle)** 的容量之和。
*   **注意**: 大本营和其他建筑不提供基础容量。

## 3. 进攻与回放系统

进攻回放数据独立于主存档保存。

*   **文件位置**: `Resources/record/`
*   **文件命名**: `关卡名_时间戳.json` (例如 `Level-1_20251217_103000.json`)
*   **保存流程**:
    1.  **开始进攻**: `RecordManager` 开始记录所有下兵和法术操作。
    2.  **结束进攻**: 战斗结束（倒计时结束或点击按钮）时，生成回放文件。
    3.  **列表更新**: 系统自动更新 `Resources/record/summary.json`，将新回放添加到回放列表中。

---
*文档生成日期: 2025-12-17*
